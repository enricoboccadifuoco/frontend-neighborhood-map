var nyTimesService=function(a){if(a){var b="http://api.nytimes.com/svc/search/v2/articlesearch.json?q="+a+"&page=0&sort=newest&api-key=5b283515d351e3a4795aa7be7d9455cb:18:72435683";return $.getJSON(b)}return!1},wikiSerivice=function(a){if(a){var b="https://en.wikipedia.org/w/api.php?action=opensearch&search="+a+"&callback=wikiCallback&format=json";return $.ajax(b,{dataType:"jsonp"})}return!1},Place=function(a){var b=this;return b.name=a.name,b.marker=new google.maps.Marker({map:map,position:a.geometry.location}),b.nyTimes=[],b.wikipedia=[],b.populate=function(){var a=$.Deferred();return $.when(nyTimesService(b.name),wikiSerivice(b.name)).then(function(c,d){articles=c[0].response.docs;for(var e=0;e<articles.length;e++){var f=articles[e];b.nyTimes.push({url:f.web_url,title:f.headline.main,text:f.snippet})}var g=d[0][1];g.forEach(function(a){var c="http://en.wikipedia.org/wiki/"+a;b.wikipedia.push({url:c,title:a})}),a.resolve(b)}),a},b},map,infowindow,center={lat:40.7127,lng:-74.0059},mapOptions={center:center,zoom:12,maxZoom:12,minZoom:12,disableDefaultUI:!0,scrollwheel:!1,draggable:!0,mapTypeId:google.maps.MapTypeId.ROADMAP},View={renderPlace:function(a){var b="<h3>"+a.name+"</h3>";a.nyTimes.length&&(b+="<h4>NY Times</h4>"),a.nyTimes.forEach(function(a){b+='<li class="article"><a href="'+a.url+'">'+a.title+"</a><p>"+a.text+"</p></li>"}),a.wikipedia.length&&(b+="<h4>Wikipedia</h4>"),a.wikipedia.forEach(function(a){b+='<li><a href="'+a.url+'">'+a.title+"</a></li>"}),infowindow.setContent(b),infowindow.open(map,a.marker)}},ViewModel=function(){var a=this;a.filter=ko.observable(""),a.places=ko.observableArray([]),this.init=function(){map=new google.maps.Map(document.getElementById("map-canvas"),mapOptions),infowindow=new google.maps.InfoWindow({maxWidth:200});var b=new google.maps.places.PlacesService(map);b.nearbySearch({location:center,radius:5e3},function(b,c){if(c==google.maps.places.PlacesServiceStatus.OK)for(var d=0;d<b.length;d++){var e=new Place(b[d]);!function(a){google.maps.event.addListener(a.marker,"click",function(){infowindow.setContent("loading"),infowindow.open(map,a.marker),a.populate().then(function(b){View.renderPlace(a)})})}(e),e.focus=function(a){return function(){infowindow.setContent("loading"),infowindow.open(map,a.marker),a.populate().then(function(b){View.renderPlace(a)})}}(e),a.places.push(e)}})},this.filteredPlaces=ko.computed(function(){return a.filter().length<=0?a.places():ko.utils.arrayFilter(a.places(),function(b){return b.name.toLowerCase().indexOf(a.filter().toLowerCase())>-1})}),this.init()};ko.applyBindings(new ViewModel);